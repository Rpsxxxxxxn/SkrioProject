(()=>{var t={58:t=>{t.exports={SERVER_LOOP_TIME:1e3/30,FIELD_SIZE:14142,FOOD_COUNT:100,PLAYER_MIN_CELL_COUNT:16,PLAYER_MAX_DUAL_COUNT:2,PLAYER_VIEW_SCALE:.3,PLAYER_VIEW_SIZE:700,PLAYER_REMERGE_TIME:100,PLAYER_START_MASS:5e3,PLAYER_SPLIT_POSITION:50,PLAYER_SPLIT_DISTANCE:780,PLAYER_COLLISION_DETECT_TIME:15,CELL_MIN_MASS:30,CELL_MAX_MASS:22500,CELL_EAT_RATE:1.25,EJECT_MASS:13,EJECT_SHOT_POSITION:20}},748:(t,e,s)=>{const i=s(58),n=s(213);t.exports=class{static rgbToHex(t,e,s){return"#"+(16777216+(t<<16|e<<8|s<<0)).toString(16).slice(1)}static hexToRgb(t){const e=t.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(e)return e.slice(1).map((t=>parseInt(t,16)));const s=t.match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i);return s?s.slice(1).map((t=>17*parseInt(t,16))):null}static clamp(t,e,s){return Math.min(Math.max(t,e),s)}static stringSlice(t,e){return t.length>e?t.slice(e,t.length):t}static getRandomPosition(){const t=new n(0,0);return t.x=65535*Math.random()%i.FIELD_SIZE,t.y=65535*Math.random()%i.FIELD_SIZE,t}static getRandomColor(){const t=this.clamp(255*Math.random(),100,255),e=this.clamp(255*Math.random(),100,255),s=this.clamp(255*Math.random(),100,255);return this.rgbToHex(t,e,s)}}},213:t=>{class e{constructor(t,e){this.x=0|t,this.y=0|e}set(t,e){this.x=t,this.y=e}add(t){this.x+=t.x,this.y+=t.y}subtract(t){this.x-=t.x,this.y-=t.y}multiply(t){this.x*=t.x,this.y*=t.y}divide(t){this.x/=t.x,this.y/=t.y}direction(t){return new e(t.x-this.x,t.y-this.y)}squareMagnitude(){return this.x*this.x+this.y*this.y}magnitude(){return Math.sqrt(this.squareMagnitude())}normalize(){let t=this.magnitude();this.x/=t,this.y/=t}normalized(t,s){let i=new e(t,s);return i.normalize(),i}length(t){const s=t.x-this.x,i=t.y-this.y;return new e(s,i)}distance(t){let e=t.x-this.x,s=t.y-this.y;return Math.sqrt(e*e+s*s)}equals(t){return this.x==t.x&&this.y==t.y}lerp(t,s,i){return new e(t.x+(s.x-t.x)*i,t.y+(s.y-t.y)*i)}dot(t){return this.x*t.x+this.y*t.y}clamp(t,e){this.x=Math.max(Math.min(this.x,e),t),this.y=Math.max(Math.min(this.y,e),t)}clear(){this.x=this.y=0}static clone(t){return new e(t.x,t.y)}static subtract(t,s){return e.clone(t).subtract(s)}static Zero(){return new e(0,0)}static One(){return new e(1,1)}static Up(){return new e(0,1)}static Down(){return new e(0,-1)}static Left(){return new e(-1,0)}static Right(){return new e(1,0)}}t.exports=e}},e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={exports:{}};return t[i](n,n.exports,s),n.exports}(()=>{"use strict";class t{constructor(){this.data=new Map}setData(t,e){this.data.set(t,e)}getData(t){return this.data.get(t)}erase(t){this.data.delete(t)}cleanup(){this.data.clear()}}class e{constructor(){this.newkey=new Array(256),this.oldkey=new Array(256),document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this))}update(){for(let t=0;t<256;t++)this.oldkey[t]=this.newkey[t]}onKeyDown(t){for(let e=0;e<256;e++)t.keyCode==e&&(this.newkey[e]=!0)}onKeyUp(t){for(let e=0;e<256;e++)t.keyCode==e&&(this.newkey[e]=!1)}getKeyDown(t){return this.newkey[t]}getKeyUp(t){return!this.newkey[t]&&this.oldkey[t]}getKeyPressed(t){return this.newkey[t]&&!this.oldkey[t]}}class i{constructor(t,e){this.x=0|t,this.y=0|e}set(t,e){this.x=t,this.y=e}add(t){this.x+=t.x,this.y+=t.y}subtract(t){this.x-=t.x,this.y-=t.y}multiply(t){this.x*=t.x,this.y*=t.y}divide(t){this.x/=t.x,this.y/=t.y}squareMagnitude(){return this.x*this.x+this.y*this.y}magnitude(){return Math.sqrt(this.squareMagnitude())}normalize(){let t=this.magnitude();this.x/=t,this.y/=t}normalized(t,e){let s=new i(t,e);return s.normalize(),s}distance(t){let e=t.x-this.x,s=t.y-this.y;return Math.sqrt(e*e+s*s)}equals(t){return this.x==t.x&&this.y==t.y}dot(t){return this.x*t.x+this.y*t.y}clamp(t,e){this.x=Math.max(Math.min(this.x,e),t),this.y=Math.max(Math.min(this.y,e),t)}clear(){this.x=this.y=0}static lerp(t,e,s){return new i(t.x+(e.x-t.x)*s,t.y+(e.y-t.y)*s)}static clone(t){return new i(t.x,t.y)}static subtract(t,e){return i.clone(t).subtract(e)}static Zero(){return new i(0,0)}static One(){return new i(1,1)}static Up(){return new i(0,1)}static Down(){return new i(0,-1)}static Left(){return new i(-1,0)}static Right(){return new i(1,0)}}class n{constructor(){this.position=i.Zero(),this.zoom=.5,document.addEventListener("mousemove",this.onMouseMove.bind(this)),document.addEventListener("mousedown",this.onMouseDown.bind(this)),document.addEventListener("mouseup",this.onMouseUp.bind(this)),document.addEventListener("mousewheel",this.onMouseWheel.bind(this))}onMouseMove(t){this.position.set(t.clientX,t.clientY)}onMouseDown(t){}onMouseUp(t){}onMouseWheel(t){this.zoom*=Math.pow(.9,t.wheelDelta/-120||t.detail||0),this.zoom=Math.min(Math.max(this.zoom,.1),4)}getZoom(){return this.zoom}getPosition(){return this.position}getLeftClick(){return!0}getRightClick(){return!0}}class o{constructor(){this.newPosition=i.Zero(),this.position=i.Zero(),this.zoom=1,this.newZoom=1}update(){this.position=i.lerp(this.position,this.newPosition,.1)}setPosition(t,e){this.newPosition.set(t,e)}getPosition(){return this.position}getWorldToScreen(){}getScreenToWorld(t,e){return{x:(e.position.x-t.canvasWidth/2)/e.zoom+this.position.x,y:(e.position.y-t.canvasHeight/2)/e.zoom+this.position.y}}}class h{constructor(){this.canvas=document.getElementById("canvas"),this.context=this.canvas.getContext("2d")}getContext(){return this.context}updateCanvasSize(){this.canvasWidth=window.innerWidth,this.canvasHeight=window.innerHeight,this.canvas.width=this.canvasWidth,this.canvas.height=this.canvasHeight}cleanup(){this.context.clearRect(0,0,this.canvas.clientWidth,this.canvas.clientHeight)}setStrokeColor(t){this.context.strokeStyle=t}setFillColor(t){this.context.fillStyle=t}drawCircle(t,e,s){this.context.arc(t,e,s,0,2*Math.PI,!1)}drawFill(){this.context.fill()}drawStroke(){this.context.stroke()}startPath(){this.context.beginPath()}closePath(){this.context.closePath()}zoomScaling(t,e){this.context.translate(this.canvasWidth/2,this.canvasHeight/2),this.context.scale(e,e),this.context.translate(-t.x,-t.y)}save(){this.context.save()}restore(){this.context.restore()}drawGrid(t,e){this.context.save(),this.context.strokeStyle="#ffffff",this.context.globalAlpha=.2,this.context.scale(e,e);for(var s=this.canvasWidth/e,i=this.canvasHeight/e,n=(-t.x+s/2)%50-.5;n<s;n+=50)this.context.beginPath(),this.context.moveTo(n,0),this.context.lineTo(n,i),this.context.stroke();for(n=(-t.y+i/2)%50-.5;n<i;n+=50)this.context.beginPath(),this.context.moveTo(0,n),this.context.lineTo(s,n),this.context.stroke();this.context.restore()}}class a{constructor(t){this.buffer=new DataView(new ArrayBuffer(8)),this.endian=t,this.reset()}reset(){this.view=[],this.offset=0}setUint8(t){t>=0&&t<256&&this.view.push(t)}setInt8(t){t>=-128&&t<128&&this.view.push(t)}setUint16(t){this.buffer.setUint16(0,t,this.endian),this.skipBytes(2)}setInt16(t){this.buffer.setInt16(0,t,this.endian),this.skipBytes(2)}setUint32(t){this.buffer.setUint32(0,t,this.endian),this.skipBytes(4)}setInt32(t){this.buffer.setInt32(0,t,this.endian),this.skipBytes(4)}setFloat32(t){this.buffer.setFloat32(0,t,this.endian),this.skipBytes(4)}setFloat64(t){this.buffer.setFloat64(0,t,this.endian),this.skipBytes(8)}skipBytes(t){for(let e=0;e<t;e++)this.view.push(this.buffer.getUint8(e))}setString(t){this.setUint16(t.length);for(let e=0;e<t.length;e++)this.setUint16(t.charCodeAt(e))}build(){return new Uint8Array(this.view)}}s(748);class r{constructor(t,e,s,n,o,h,a){this.player=t,this.id=e,this.type=s,this.position=new i(n,o),this.newPosition=new i(n,o),this.size=h,this.oldSize=h,this.newSize=h,this.mass=this.size*this.size/100,this.color=a}update(t,e,s){this.setPosition(t,e),this.setSize(s)}setPosition(t,e){this.newPosition.set(t,e)}setSize(t){this.newSize=t,this.mass=this.newSize*this.newSize/100}setColor(t){this.color=t}draw(t,e){this.position.x=.3*(this.newPosition.x-this.position.x)+this.position.x,this.position.y=.3*(this.newPosition.y-this.position.y)+this.position.y,this.size=.3*(this.newSize-this.size)+this.size,e.startPath(),e.setFillColor(this.color),e.drawCircle(this.position.x,this.position.y,this.size),e.drawFill(),3===this.type&&(e.setFillColor("white"),e.getContext().font=.5*this.size+"px 'ＭＳ ゴシック'",e.getContext().textAlign="center",e.getContext().fillText(""+~~this.mass,this.position.x,this.position.y+.7*this.size)),e.closePath()}}class l{constructor(t,e,s){this.view=t,this.offset=e||0,this.endian=s}getInt8(){return this.view.getInt8(this.offset++,this.endian)}getInt16(){let t=this.view.getInt16(this.offset,this.endian);return this.skipBytes(2),t}getInt24(){let t=this.view.getInt16(this.offset,this.endian);return this.skipBytes(3),t}getInt32(){let t=this.view.getInt32(this.offset,this.endian);return this.skipBytes(4),t}getUint8(){return this.view.getUint8(this.offset++,this.endian)}getUint16(){let t=this.view.getUint16(this.offset,this.endian);return this.skipBytes(2),t}getUint24(){let t=this.view.getUint16(this.offset,this.endian);return this.skipBytes(3),t}getUint32(){let t=this.view.getUint32(this.offset,this.endian);return this.skipBytes(4),t}getFloat(){let t=this.view.getFloat32(this.offset,this.endian);return this.skipBytes(4),t}getDouble(){let t=this.view.getFloat64(this.offset,this.endian);return this.skipBytes(8),t}getString(){let t="",e=0;const s=this.getUint16();for(;e<s;)t+=String.fromCharCode(this.getUint16()),e+=1;return t}skipBytes(t){this.offset+=t}}class c{constructor(t,e,s,n){this.gamecore=t,this.id=e,this.team=s,this.name=n,this.cells=[],this.totalMass=0,this.skinURL={},this.mousePosition=new i(0,0),this.zoomRange=1}create(){}update(){this.totalMass=this.cells.reduce(((t,e)=>t.mass+e.mass))}draw(t){}destroy(){this.cells.clear(),this.skinURL={}}addCell(t,e,s,i,n,o){const h=new r(this,t,e,s,i,n,o);this.cells.push(h),this.gamecore.viewCells.push(h)}updateCell(t,e,s,i){this.cells.find((e=>e.id==t)).update(e,s,i)}deleteCell(t){let e=this.cells.findIndex((e=>e.id==t));this.cells.splice(e,1),e=this.gamecore.viewCells.findIndex((e=>e.id==t)),this.gamecore.viewCells.splice(e,1)}setTeam(t){this.team=t}setName(t){this.name=t}setMousePosition(t,e){this.mousePosition.set(t,e)}setSkinURL(t,e){let s=this.skinURL;s[t]=e,this.skinURL=s}}class d{constructor(t){this.gamecore=t}create(){this.ws=new WebSocket("ws://118.27.105.43:3000"),this.ws.binaryType="arraybuffer",this.ws.onopen=this.onOpen.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onclose=this.onClose.bind(this),this.ws.onerror=this.onError.bind(this)}wsSend(t){this.ws&&1==this.ws.readyState&&(t.build?this.ws.send(t.build()):this.ws.send(t.buffer))}onOpen(t){console.log("Socket Open")}onMessage(t){const e=new l(new DataView(t.data),0,!0);switch(e.getUint8()){case 0:this.setId(e);break;case 1:this.updateViewPosition(e);break;case 10:this.addPlayer(e),this.updatePlayer(e),this.deletePlayer(e);break;case 11:this.addCell(e),this.updateCell(e),this.deleteCell(e);break;case 12:this.updateTeamMember(e);break;case 20:this.serverMessage(e);break;case 21:this.chatMessage(e)}}onClose(t){console.log("Socket Close")}onError(t){console.log("Socket Error")}setId(t){let e=t.getUint32();this.gamecore.playerId=e}updateViewPosition(t){const e=t.getFloat(),s=t.getFloat();this.gamecore.camera.setPosition(e,s)}addPlayer(t){const e=t.getUint16();for(let s=0;s<e;s++){const e=t.getUint32(),s=t.getString(),i=t.getString(),n=new c(this.gamecore,e,s,i);this.gamecore.allPlayers.setData(e,n),this.gamecore.playerId==e&&(this.gamecore.player=n)}}updatePlayer(t){const e=t.getUint16();for(let s=0;s<e;s++){const e=t.getUint32(),s=this.gamecore.allPlayers.getData();s.setTeam(t.getString()),s.setName(t.getString()),this.gamecore.allPlayers.setData(e,s)}}deletePlayer(t){const e=t.getUint16();for(let s=0;s<e;s++){const e=t.getUint32();this.gamecore.allPlayers.erase(e)}}addCell(t){const e=t.getUint16();for(let s=0;s<e;s++){const e=t.getUint32(),s=t.getUint8(),i=t.getFloat(),n=t.getFloat(),o=t.getUint16(),h=t.getString();if(3==s){const a=t.getUint16(),r=this.gamecore.allPlayers.getData(a);r.addCell(e,s,i,n,o,h),this.gamecore.allPlayers.setData(a,r)}else{const t=new r(null,e,s,i,n,o,h);this.gamecore.viewCells.push(t)}}}updateCell(t){const e=t.getUint16();for(let s=0;s<e;s++){const e=t.getUint32(),s=t.getUint8(),i=t.getFloat(),n=t.getFloat(),o=t.getUint16();if(3==s){const s=t.getUint16(),h=this.gamecore.allPlayers.getData(s);null!=h&&h.updateCell(e,i,n,o)}else{const t=this.gamecore.viewCells.find((t=>t.id==e));void 0!==t&&t.update(i,n,o)}}}deleteCell(t){const e=t.getUint16();for(let s=0;s<e;s++){const e=t.getUint32();if(3==t.getUint8()){const s=t.getUint16(),i=this.gamecore.allPlayers.getData(s);i.deleteCell(e),this.gamecore.allPlayers.setData(e,i)}else{const t=this.gamecore.viewCells.findIndex((t=>t.id==e));this.gamecore.viewCells.splice(t,1)}}}updateTeamMember(t){const e=t.getUint16(),s=t.getUint16(),i=this.gamecore.allPlayers.getData(e);for(let e=0;e<s;e++)t.getFloat(),t.getFloat(),t.getFloat(),t.getFloat(),i.setMousePosition(x,y)}serverMessage(t){}chatMessage(t){}}const u=new class{constructor(){this.viewCells=[],this.allPlayers=new t,this.skinURLCache=new t,this.playerId=-1,this.player=null,this.mouse=null,this.keyboard=null,this.camera=null,this.saveTime=null}create(){this.render=new h,this.socket=new d(this),this.socket.create(),this.mouse=new n,this.keyboard=new e,this.camera=new o,setInterval((()=>{const t=this.camera.getScreenToWorld(this.render,this.mouse),e=new a(!0);e.setUint8(1),e.setInt32(t.x),e.setInt32(t.y),e.setFloat32(this.mouse.getZoom()),this.socket.wsSend(e)}),50)}update(){if(this.keyboard.getKeyPressed(40)){const t=new a(!0);t.setUint8(0),t.setString("もち"),t.setString("管理者"),t.setUint8(0),this.socket.wsSend(t)}if(this.keyboard.getKeyPressed(32)){const t=new a(!0);t.setUint8(5),this.socket.wsSend(t)}if(this.keyboard.getKeyDown(69)){const t=new a(!0);t.setUint8(8),this.socket.wsSend(t)}if(this.keyboard.getKeyPressed(81)){const t=new a(!0);t.setUint8(2),this.socket.wsSend(t)}this.keyboard.update(),this.camera.update()}draw(){this.render.cleanup(),this.render.updateCanvasSize(),this.render.drawGrid(this.camera.getPosition(),this.mouse.getZoom()),this.viewCells.sort(((t,e)=>t.size-e.size)),this.render.save(),this.render.zoomScaling(this.camera.getPosition(),this.mouse.getZoom()),this.render.setStrokeColor("white"),this.render.getContext().strokeRect(0,0,14142,14142),this.viewCells.forEach((t=>{t.draw(this.saveTime,this.render)})),this.player&&this.player.draw(this.render),this.render.restore(),this.saveTime=Date.now()}};function g(){u.update(),u.draw(),requestAnimationFrame(g)}window.onload=function(){u.create(),g()}})()})();
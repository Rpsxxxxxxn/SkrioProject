(()=>{"use strict";class t{constructor(){this.data=new Map}setData(t,e){this.data.set(t,e)}getData(t){return this.data.get(t)}erase(t){this.data.delete(t)}cleanup(){this.data.clear()}}class e{constructor(){this.newkey=new Array(256),this.oldkey=new Array(256),document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this))}onKeyDown(t){for(let e=0;e<256;e++)t.keyCode==e&&(this.oldkey[e]=this.newkey[e],this.newkey[e]=!0)}onKeyUp(t){for(let e=0;e<256;e++)t.keyCode==e&&(this.oldkey[e]=this.newkey[e],this.newkey[e]=!1)}getKeyDown(t){return this.newkey[t]}getKeyUp(t){return!this.newkey[t]&&this.oldkey[t]}getKeyPressed(t){return this.newkey[t]&&!this.oldkey[t]}}class s{constructor(t,e){this.x=0|t,this.y=0|e}set(t,e){this.x=t,this.y=e}add(t){this.x+=t.x,this.y+=t.y}subtract(t){this.x-=t.x,this.y-=t.y}multiply(t){this.x*=t.x,this.y*=t.y}divide(t){this.x/=t.x,this.y/=t.y}squareMagnitude(){return this.x*this.x+this.y*this.y}magnitude(){return Math.sqrt(this.squareMagnitude())}normalize(){let t=this.magnitude();this.x/=t,this.y/=t}normalized(t,e){let i=new s(t,e);return i.normalize(),i}distance(t){let e=t.x-this.x,s=t.y-this.y;return Math.sqrt(e*e+s*s)}equals(t){return this.x==t.x&&this.y==t.y}dot(t){return this.x*t.x+this.y*t.y}clamp(t,e){this.x=Math.max(Math.min(this.x,e),t),this.y=Math.max(Math.min(this.y,e),t)}static lerp(t,e,i){return new s(t.x+(e.x-t.x)*i,t.y+(e.y-t.y)*i)}static clone(t){return new s(t.x,t.y)}static subtract(t,e){return s.clone(t).subtract(e)}static Zero(){return new s(0,0)}static One(){return new s(1,1)}static Up(){return new s(0,1)}static Down(){return new s(0,-1)}static Left(){return new s(-1,0)}static Right(){return new s(1,0)}}class i{constructor(){this.position=s.Zero(),this.zoom=.5,document.addEventListener("mousemove",this.onMouseMove.bind(this)),document.addEventListener("mousedown",this.onMouseDown.bind(this)),document.addEventListener("mouseup",this.onMouseUp.bind(this)),document.addEventListener("mousewheel",this.onMouseWheel.bind(this))}onMouseMove(t){this.position.set(t.clientX,t.clientY)}onMouseDown(t){}onMouseUp(t){}onMouseWheel(t){this.zoom*=Math.pow(.9,t.wheelDelta/-120||t.detail||0),this.zoom=Math.min(Math.max(this.zoom,.1),4)}getZoom(){return this.zoom}getPosition(){return this.position}getLeftClick(){return!0}getRightClick(){return!0}}class n{constructor(){this.newPosition=s.Zero(),this.position=s.Zero(),this.zoom=1,this.newZoom=1}update(){this.position=s.lerp(this.newPosition,this.position,.03)}setPosition(t,e){this.newPosition.set(t,e)}getPosition(){return this.position}getWorldToScreen(){}getScreenToWorld(t,e){return{x:(e.position.x-t.canvasWidth/2)/e.viewZoom+this.position.x,y:(e.position.y-t.canvasHeight/2)/e.viewZoom+this.position.y}}}class o{constructor(){this.canvas=document.getElementById("canvas"),this.context=this.canvas.getContext("2d")}getContext(){return this.context}updateCanvasSize(){this.canvasWidth=window.innerWidth,this.canvasHeight=window.innerHeight,this.canvas.width=this.canvasWidth,this.canvas.height=this.canvasHeight}cleanup(){this.context.clearRect(0,0,this.canvas.clientWidth,this.canvas.clientHeight)}setStrokeColor(t){this.context.strokeStyle=t}setFillColor(t){this.context.fillStyle=t}drawCircle(t,e,s){this.context.arc(t,e,s,0,2*Math.PI,!1)}drawFill(){this.context.fill()}drawStroke(){this.context.stroke()}startPath(){this.context.beginPath()}closePath(){this.context.closePath()}drawGrid(t,e){this.context.save(),this.context.strokeStyle="#ffffff",this.context.globalAlpha=.2,this.context.scale(e,e);for(var s=this.canvasWidth/e,i=this.canvasHeight/e,n=(-t.x+s/2)%50-.5;n<s;n+=50)this.context.beginPath(),this.context.moveTo(n,0),this.context.lineTo(n,i),this.context.stroke();for(n=(-t.y+i/2)%50-.5;n<i;n+=50)this.context.beginPath(),this.context.moveTo(0,n),this.context.lineTo(s,n),this.context.stroke();this.context.restore()}}class h{constructor(t){this.buffer=new DataView(new ArrayBuffer(8)),this.endian=t,this.reset()}reset(){this.view=[],this.offset=0}setUint8(t){t>=0&&t<256&&this.view.push(t)}setInt8(t){t>=-128&&t<128&&this.view.push(t)}setUint16(t){this.buffer.setUint16(0,t,this.endian),this.skipBytes(2)}setInt16(t){this.buffer.setInt16(0,t,this.endian),this.skipBytes(2)}setUint32(t){this.buffer.setUint32(0,t,this.endian),this.skipBytes(4)}setInt32(t){this.buffer.setInt32(0,t,this.endian),this.skipBytes(4)}setFloat32(t){this.buffer.setFloat32(0,t,this.endian),this.skipBytes(4)}setFloat64(t){this.buffer.setFloat64(0,t,this.endian),this.skipBytes(8)}skipBytes(t){for(let e=0;e<t;e++)this.view.push(this.buffer.getUint8(e))}setString(t){this.setUint16(t.length);for(let e=0;e<t.length;e++)this.setUint16(t.charCodeAt(e))}build(){return new Uint8Array(this.view)}}class a{constructor(t,e,i,n,o,h,a){this.player=t,this.id=e,this.type=i,this.position=new s(n,o),this.size=h,this.mass=this.size*this.size/100,this.color=a}update(t,e,s){this.setPosition(t,e),this.setSize(s)}setPosition(t,e){this.position.set(t,e)}setSize(t){this.size=t,this.mass=this.size*this.size/100}setColor(t){this.color=t}draw(t){t.startPath(),t.setFillColor(this.color),t.drawCircle(this.position.x,this.position.y,this.size),t.drawFill(),t.closePath()}}class r{constructor(t,e,s){this.view=t,this.offset=e||0,this.endian=s}getInt8(){return this.view.getInt8(this.offset++,this.endian)}getInt16(){let t=this.view.getInt16(this.offset,this.endian);return this.skipBytes(2),t}getInt24(){let t=this.view.getInt16(this.offset,this.endian);return this.skipBytes(3),t}getInt32(){let t=this.view.getInt32(this.offset,this.endian);return this.skipBytes(4),t}getUint8(){return this.view.getUint8(this.offset++,this.endian)}getUint16(){let t=this.view.getUint16(this.offset,this.endian);return this.skipBytes(2),t}getUint24(){let t=this.view.getUint16(this.offset,this.endian);return this.skipBytes(3),t}getUint32(){let t=this.view.getUint32(this.offset,this.endian);return this.skipBytes(4),t}getFloat(){let t=this.view.getFloat32(this.offset,this.endian);return this.skipBytes(4),t}getDouble(){let t=this.view.getFloat64(this.offset,this.endian);return this.skipBytes(8),t}getString(){let t="",e=0;const s=this.getUint16();for(;e<s;)t+=String.fromCharCode(this.getUint16()),e+=1;return t}skipBytes(t){this.offset+=t}}class l{constructor(t,e,i,n){this.gamecore=t,this.id=e,this.team=i,this.name=n,this.cells=[],this.totalMass=0,this.skinURL={},this.mousePosition=new s(0,0),this.zoomRange=1}create(){}update(){this.totalMass=this.cells.reduce(((t,e)=>t.mass+e.mass))}draw(t){}destroy(){this.cells.clear(),this.skinURL={}}addCell(t,e,s,i,n){const o=new a(this,t,e,s,i,n);this.cells.push(o),this.gamecore.viewCells.push(o)}updateCell(t,e,s,i){this.cells.find((e=>e.id==t)).update(e,s,i)}deleteCell(t){const e=this.cells.findIndex((e=>e.id==t));this.cells.splice(e,1),this.gamecore.splice(e,1)}setTeam(t){this.team=t}setName(t){this.name=t}setMousePosition(t,e){this.mousePosition.set(t,e)}setSkinURL(t,e){let s=this.skinURL;s[t]=e,this.skinURL=s}}class c{constructor(t){this.gamecore=t}create(){this.ws=new WebSocket("ws://localhost:3000"),this.ws.binaryType="arraybuffer",this.ws.onopen=this.onOpen.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onclose=this.onClose.bind(this),this.ws.onerror=this.onError.bind(this)}wsSend(t){this.ws&&1==this.ws.readyState&&(t.build?this.ws.send(t.build()):this.ws.send(t.buffer))}onOpen(t){console.log("Socket Open")}onMessage(t){const e=new r(new DataView(t.data),0,!0);switch(e.getUint8()){case 0:this.setId(e);break;case 10:this.addPlayer(e),this.updatePlayer(e),this.deletePlayer(e);break;case 11:this.addCell(e),this.updateCell(e),this.deleteCell(e);break;case 12:this.updateTeamMember(e);break;case 20:this.serverMessage(e);break;case 21:this.chatMessage(e)}}onClose(t){console.log("Socket Close")}onError(t){console.log("Socket Error")}setId(t){let e=t.getUint32();this.gamecore.playerId=e,console.log(e)}addPlayer(t){const e=t.getUint16();for(let s=0;s<e;s++){const e=t.getUint32(),s=t.getString(),i=t.getString(),n=new l(this.gamecore,e,s,i);this.gamecore.allPlayers.setData(e,n)}}updatePlayer(t){const e=t.getUint16();for(let s=0;s<e;s++){const e=t.getUint32(),s=this.gamecore.allPlayers.getData();s.setTeam(t.getString()),s.setName(t.getString()),this.gamecore.allPlayers.setData(e,s)}}deletePlayer(t){const e=t.getUint16();for(let s=0;s<e;s++){const e=t.getUint32();this.gamecore.allPlayers.erase(e)}}addCell(t){const e=t.getUint16();for(let s=0;s<e;s++){const e=t.getUint32(),s=t.getUint8(),i=t.getFloat(),n=t.getFloat(),o=t.getUint16();if(3==s){const h=t.getUint16(),a=this.gamecore.allPlayers.getData(h);a.addCell(e,s,i,n,o),this.gamecore.allPlayers.setData(id,a)}else{const t=new a(null,e,s,i,n,o,"yellow");this.gamecore.viewCells.push(t)}}}updateCell(t){const e=t.getUint16(),s=t.getUint16();for(let i=0;i<s;i++){const s=t.getUint32(),i=t.getUint8(),n=t.getFloat(),o=t.getFloat(),h=t.getUint16();if(3==i){const t=this.gamecore.allPlayers.getData(e);t.updateCell(s,n,o,h),this.gamecore.allPlayers.setData(id,t)}else this.gamecore.viewCells.find((t=>t.id==s)).update(n,o,h)}}deleteCell(t){const e=t.getUint16(),s=t.getUint16();for(let i=0;i<s;i++){const s=t.getUint32();if(3==t.getUint8()){const t=this.gamecore.allPlayers.getData(e);t.deleteCell(s),this.gamecore.allPlayers.setData(s,t)}else{const t=this.gamecore.viewCells.findIndex((t=>t.id==s));this.gamecore.viewCells.splice(t,1)}}}updateTeamMember(t){const e=t.getUint16(),s=t.getUint16(),i=this.gamecore.allPlayers.getData(e);for(let e=0;e<s;e++)t.getFloat(),t.getFloat(),t.getFloat(),t.getFloat(),i.setMousePosition(x,y)}serverMessage(t){}chatMessage(t){}}const d=new class{constructor(){this.viewCells=[],this.allPlayers=new t,this.skinURLCache=new t,this.playerId=-1,this.player=null,this.mouse=null,this.keyboard=null,this.camera=null}create(){this.render=new o,this.socket=new c(this),this.socket.create(),this.mouse=new i,this.keyboard=new e,this.camera=new n}update(){if(this.keyboard.getKeyPressed(40)){const t=new h;t.setUint8(0),t.setString(""),t.setString(""),t.setUint8(0),this.socket.wsSend(t)}}draw(){this.render.cleanup(),this.render.updateCanvasSize(),this.render.drawGrid(this.camera.getPosition(),this.mouse.getZoom()),this.viewCells.sort(((t,e)=>t-e)),this.viewCells.forEach((t=>{t.draw(this.render)})),this.player&&this.player.draw(this.render),this.render.startPath(),this.render.setFillColor("#ffffff"),this.render.drawCircle(0,0,10),this.render.drawFill(),this.render.closePath()}};function g(){d.update(),d.draw(),requestAnimationFrame(g)}window.onload=function(){d.create(),g()}})();